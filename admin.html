<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin - Airbag & Radar Solutions</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
  body{background:#f4f4f4;color:#333}
  header{background:#0d1b2a;color:#fff;padding:20px;text-align:center}
  nav{display:flex;justify-content:center;gap:10px;background:#1b263b;padding:10px;flex-wrap:wrap}
  nav button{background:#415a77;color:#fff;border:none;padding:12px 24px;font-size:16px;cursor:pointer;border-radius:4px;transition:.3s}
  nav button:hover{background:#778da9}
  section{display:none;padding:20px;max-width:1200px;margin:auto;background:#fff;min-height:70vh}
  section.active{display:block}
  h2{margin-bottom:15px;color:#1b263b}
  .admin-only{background:#e7f3ff;border:2px dashed #2196F3;padding:15px;margin-bottom:20px;border-radius:6px}
  .stat-card{background:white;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center}
  .stat-number{font-size:2em;color:#28a745;font-weight:bold;margin:10px 0}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ccc;padding:8px;text-align:center}
  th{background:#f2f2f2}
  input[type=number],input[type=text],select,textarea{width:100%;padding:6px;margin:4px 0}
  button{padding:8px 12px;margin:4px;cursor:pointer}
  .progress-bar{width:100%;height:18px;background:#e0e0e0;border-radius:9px;overflow:hidden;margin-bottom:5px}
  .progress-bar div{height:100%;background:#28a745;width:0%;transition:width .3s;text-align:center;color:#fff;font-size:12px;line-height:18px}
  footer{text-align:center;padding:20px;background:#0d1b2a;color:#fff}
</style>
</head>
<body>

<!-- CAPA PIN -->
<div id="login" style="position:fixed;inset:0;background:#0d1b2a;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999">
  <h2>Acceso Administrativo</h2>
  <input id="pin" type="password" placeholder="PIN de 4 d√≠gitos" maxlength="4" style="margin:10px;padding:8px;width:150px;text-align:center">
  <button onclick="verificarPin()">Entrar</button>
</div>

<!-- CONTENIDO ADMIN -->
<div id="panel" style="display:none">

<header>
  <h1>üîß Admin - Airbag & Radar Solutions</h1>
  <p>Panel de control completo</p>
</header>

<nav>
  <button onclick="mostrar('dashboard')">Dashboard</button>
  <button onclick="mostrar('ordenes')">√ìrdenes</button>
  <button onclick="mostrar('tienda')">Tienda Admin</button>
  <button onclick="mostrar('inventario')">Inventario 300</button>
  <button onclick="mostrar('contacto')">Contacto</button>
</nav>

<!-- 1. DASHBOARD -->
<section id="dashboard" class="active">
  <h2>üìä Dashboard de Airbag & Radar Solutions</h2>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
    <div class="stat-card"><h3>Ordenes Mes</h3><p class="stat-number" id="ordenesMes">0</p></div>
    <div class="stat-card"><h3>Ingresos Mes</h3><p class="stat-number" id="ingresosMes">$0</p></div>
    <div class="stat-card"><h3>Productos Vendidos</h3><p class="stat-number" id="productosVendidos">0</p></div>
    <div class="stat-card"><h3>Clientes Nuevos</h3><p class="stat-number" id="clientesNuevos">0</p></div>
  </div>
</section>

<!-- 2. √ìRDENES -->
<section id="ordenes">
  <h2>üîß √ìrdenes de Trabajo - Airbag & Radar Solutions</h2>
  <div class="admin-only">
    <h3>Nueva orden</h3>
    <input type="text" id="ordCliente" placeholder="Nombre cliente">
    <input type="text" id="ordAuto" placeholder="Marca / Modelo / A√±o">
    <select id="ordServicio">
      <option>Diagn√≥stico SRS</option>
      <option>Reparaci√≥n m√≥dulo</option>
      <option>Calibraci√≥n radar</option>
      <option>Venta de airbag</option>
    </select>
    <button onclick="nuevaOrden()">Crear orden</button>
  </div>
  <h3>Listado de √≥rdenes</h3>
  <table id="tablaOrdenes">
    <thead><tr><th>#</th><th>Fecha</th><th>Cliente</th><th>Veh√≠culo</th><th>Servicio</th><th>Estado</th><th>Acciones</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- 3. TIENDA ADMIN -->
<section id="tienda">
  <h2>üõí Tienda Admin - Airbag & Radar Solutions</h2>
  <div id="catalogoCliente"></div>
  <div id="carritoUI" class="admin-only">
    <h3>Carrito</h3>
    <div id="itemsCarrito"></div>
    <hr><strong>Total: $<span id="totalCarrito">0</span></strong><br>
    <button onclick="pagar()">Pagar (simulado)</button>
  </div>
</section>

<!-- 4. INVENTARIO 300 PRODUCTOS -->
<section id="inventario">
  <h2>üì¶ Inventario 300 Productos - Admin</h2>

  <!-- BOT√ìN PARA GUARDAR CAMBIOS EN GITHUB -->
  <div class="admin-only" style="margin:20px 0;border:2px dashed #28a745;padding:15px">
    <h3>üíæ Guardar cambios en GitHub</h3>
    <button onclick="guardarCambiosEnGitHub()">Subir CSV actualizado</button>
    <p id="resGitHub"></p>
  </div>

  <!-- CARGA MASIVA POR CSV -->
  <div class="admin-only" style="margin:20px 0;border:2px dashed #2196F3;padding:15px">
    <h3>1. Descarg√° la plantilla Excel (300 productos)</h3>
    <a href="data:text/csv;charset=utf-8,codigo_oem,nombre,marca,modelo,anio,precio,stock,imagen_url,descripcion%0AVOL-CIV-18,Airbag Volante,Honda,Civic,2018,3500,5,https://i.imgur.com/ejemplo1.jpg,Original Honda%0AAIR-COP-20,Airbag Copiloto,Toyota,RAV4,2020,2800,3,https://i.imgur.com/ejemplo2.jpg,Original Toyota%0AMOD-SRS-19,M√≥dulo SRS,Nissan,Sentra,2019,3200,7,https://i.imgur.com/ejemplo3.jpg,M√≥dulo restaurado%0ASEN-IMP-21,Sensor Impacto,Mazda,3,2021,1500,10,https://i.imgur.com/ejemplo4.jpg,Sensor nuevo" download="plantilla_productos.csv">‚¨áÔ∏è plantilla_productos.csv</a>
    <h3>2. Seleccion√° tu archivo CSV (hasta 300 filas)</h3>
    <input type="file" id="csvFile" accept=".csv" />
    <button onclick="cargarCSV()">Cargar / actualizar productos</button>
    <p id="resCSV"></p>
  </div>

  <!-- EDICI√ìN R√ÅPIDA INDIVIDUAL -->
  <div class="admin-only">
    <h3>Editar producto individual</h3>
    <input type="text" id="quickCodigo" placeholder="C√≥digo OEM">
    <input type="text" id="quickNombre" placeholder="Nombre">
    <input type="text" id="quickMarca" placeholder="Marca">
    <input type="text" id="quickModelo" placeholder="Modelo">
    <input type="text" id="quickAnio" placeholder="A√±o">
    <input type="number" id="quickPrecio" placeholder="Precio" min="0">
    <input type="number" id="quickStock" placeholder="Stock" min="0">
    <input type="text" id="quickImg" placeholder="URL imagen (opcional)">
    <textarea id="quickDesc" rows="2" placeholder="Descripci√≥n (opcional)"></textarea>
    <button onclick="agregarProducto()">Agregar / Actualizar</button>
  </div>

  <!-- LISTADO PAGINADO -->
  <div id="listaProductos"></div>
  <button onclick="cambiarPagina(-1)">‚¨Ö Anterior</button>
  <button onclick="cambiarPagina(1)">Siguiente ‚û°</button>
</section>

<!-- 5. CONTACTO -->
<section id="contacto">
  <h2>Contacto - Airbag & Radar Solutions</h2>
  <a href="mailto:ventas@airbagradarsolutions.com" style="display:inline-block;background:#28a745;color:#fff;padding:12px 24px;border-radius:4px;text-decoration:none;margin-bottom:15px">üìß Correo</a>
  <a href="https://wa.me/526611721599?text=Hola ,%20vengo%20de%20Airbag%20&%20Radar%20Solutions%20y%20necesito%20informaci√≥n." style="display:inline-block;background:#25D366;color:#fff;padding:12px 24px;border-radius:4px;text-decoration:none">üì≤ WhatsApp +52 661 172 1599</a>
</section>

<footer>Airbag & Radar Solutions ¬© 2025</footer>
</div>

<script>
/* ---------- PIN DE ENTRADA ---------- */
function verificarPin(){
  if(document.getElementById('pin').value==='1234'){
    document.getElementById('login').style.display='none';
    document.getElementById('panel').style.display='block';
    iniciarTodo();
  }else{
    alert('PIN incorrecto'); 
    window.location.href='index.html';
  }
}

/* ---------- NAVEGACI√ìN ---------- */
function mostrar(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='dashboard') actualizarDashboard();
  if(id==='ordenes') renderOrdenes();
  if(id==='tienda'){renderTienda(); mostrarDescripcion();}
  if(id==='inventario') renderInventario();
}

/* ---------- DASHBOARD ---------- */
function actualizarDashboard(){
  const ordenes=JSON.parse(localStorage.getItem('ordenes')||'[]');
  const mes=new Date().getMonth();
  const delMes=ordenes.filter(o=>new Date(o.fecha).getMonth()===mes);
  document.getElementById('ordenesMes').textContent=delMes.length;
  const ingresos=delMes.reduce((s,o)=>s+parseFloat(o.costo||0),0);
  document.getElementById('ingresosMes').textContent='$'+ingresos.toFixed(2);
  document.getElementById('productosVendidos').textContent=delMes.filter(o=>o.servicio.includes('Venta')).length;
  document.getElementById('clientesNuevos').textContent=[...new Set(delMes.map(o=>o.cliente))].length;
}

/* ---------- √ìRDENES ---------- */
class SistemaOrdenes{
  constructor(){
    this.ordenes=JSON.parse(localStorage.getItem('ordenes')||'[]');
    this.numero=parseInt(localStorage.getItem('numeroOrden')||'1000');
  }
  crear(cliente,auto,servicio){
    this.numero++;
    const orden={numero:this.numero,fecha:new Date().toLocaleDateString(),cliente,auto,servicio,estado:'Diagn√≥stico',costo:0,notas:''};
    this.ordenes.unshift(orden);
    this.guardar();
    return this.numero;
  }
  cambiarEstado(numero,estado){
    const o=this.ordenes.find(x=>x.numero==numero);
    if(o){o.estado=estado;this.guardar();alert(`Orden #${numero} ahora es: ${estado}`);}
  }
  guardar(){
    localStorage.setItem('ordenes',JSON.stringify(this.ordenes));
    localStorage.setItem('numeroOrden',this.numero);
  }
}
const sisOrdenes=new SistemaOrdenes();

function nuevaOrden(){
  const cliente=document.getElementById('ordCliente').value;
  const auto=document.getElementById('ordAuto').value;
  const servicio=document.getElementById('ordServicio').value;
  if(!cliente||!auto)return alert('Completa cliente y veh√≠culo');
  const num=sisOrdenes.crear(cliente,auto,servicio);
  alert(`Orden #${num} creada`);
  renderOrdenes();
}

function renderOrdenes(){
  const tbody=document.querySelector('#tablaOrdenes tbody');
  tbody.innerHTML='';
  sisOrdenes.ordenes.forEach(o=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${o.numero}</td><td>${o.fecha}</td><td>${o.cliente}</td><td>${o.auto}</td><td>${o.servicio}</td>
      <td>${o.estado}</td>
      <td>
        <select onchange="sisOrdenes.cambiarEstado(${o.numero},this.value)">
          <option ${o.estado==='Diagn√≥stico'?'selected':''}>Diagn√≥stico</option>
          <option ${o.estado==='Reparaci√≥n'?'selected':''}>Reparaci√≥n</option>
          <option ${o.estado==='Pruebas'?'selected':''}>Pruebas</option>
          <option ${o.estado==='Entregado'?'selected':''}>Entregado</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- TIENDA ADMIN ---------- */
const carrito=[];
function renderTienda(){
  const div=document.getElementById('catalogoCliente');
  let html='';
  const lista=JSON.parse(localStorage.getItem('productos300'))||[];
  lista.slice(0,20).forEach(p=>{
    html+=`
      <div class="producto-card">
        <strong>${p.nombre}</strong> (${p.codigo_oem})<br>
        Marca: ${p.marca} | Modelo: ${p.modelo} | A√±o: ${p.anio}<br>
        Precio: <b>$${p.precio}</b> | Stock: ${p.stock}<br>
        <button onclick="agregarCarrito('${p.codigo_oem}','${p.nombre}',${p.precio})">Agregar al carrito</button>
        <button onclick="wpProducto('${p.codigo_oem}','${p.nombre}',${p.precio},${p.stock})">Comprar por WhatsApp</button>
      </div>`;
  });
  div.innerHTML=html;
  actualizarCarrito();
}

function agregarCarrito(id,nombre,precio){
  const existe=carrito.find(i=>i.id===id);
  if(existe){existe.cantidad++}else{carrito.push({id,nombre,precio,cantidad:1})}
  actualizarCarrito();
}

function actualizarCarrito(){
  const div=document.getElementById('itemsCarrito');
  div.innerHTML='';
  let total=0;
  carrito.forEach(i=>{
    total+=i.precio*i.cantidad;
    div.innerHTML+=`<div class="carrito-item">${i.nombre} x${i.cantidad} = $${i.precio*i.cantidad} <button onclick="quitarCarrito('${i.id}')">Quitar</button></div>`;
  });
  document.getElementById('totalCarrito').textContent=total.toFixed(2);
}

function quitarCarrito(id){
  const idx=carrito.findIndex(i=>i.id===id);
  if(idx>-1){carrito.splice(idx,1);actualizarCarrito();}
}

function pagar(){
  alert('Pago simulado completado. Gracias por tu compra en Airbag & Radar Solutions.');
  carrito.length=0;actualizarCarrito();
}

/* ---------- WHATSAPP ---------- */
function wpProducto(codigo,nombre,precio,stock){
  const texto=`Hola, vengo de Airbag & Radar Solutions y quiero comprar:\n\nC√≥digo: ${codigo}\nProducto: ${nombre}\nPrecio: $${precio} MXN\nStock: ${stock} unidades\n\n¬øC√≥mo hago el dep√≥sito?`;
  window.open(`https://wa.me/526611721599?text=${encodeURIComponent(texto)}`,'_blank');
}

/* ---------- GUARDAR CAMBIOS EN GITHUB ---------- */
const TOKEN = "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";
async function guardarCambiosEnGitHub(){
  const lista   = JSON.parse(localStorage.getItem('productos300'))||[];
  const csv     = Papa.unparse(lista);
  const encoded = btoa(unescape(encodeURIComponent(csv)));
  const url     = 'https://api.github.com/repos/xlaraislas-tech/airbag-radar-solutions/contents/productos-ml-final-v10.csv';

  try{
    const getRes = await fetch(url, {headers:{Authorization:'token '+TOKEN}});
    const sha    = getRes.ok ? (await getRes.json()).sha : null;
    const body = {
      message:'Actualizaci√≥n autom√°tica desde admin.html',
      content:encoded,
      sha:sha
    };
    const putRes = await fetch(url,{
      method:'PUT',
      headers:{
        Authorization:'token '+TOKEN,
        'Content-Type':'application/json'
      },
      body:JSON.stringify(body)
    });
    const resMsg = putRes.ok ? '‚úÖ CSV subido correctamente. La tienda se actualizar√° en 30-60 s.'
                               : '‚ùå Error: '+(await putRes.json()).message;
    document.getElementById('resGitHub').textContent=resMsg;
  }catch(e){
    document.getElementById('resGitHub').textContent='‚ùå Error de red: '+e.message;
  }
}

/* ---------- INVENTARIO ---------- */
let productos = JSON.parse(localStorage.getItem('productos300'))||[];
let pagina = 1;
const POR_PAG = 20;

function cargarCSV(){
  const file=document.getElementById('csvFile').files[0];
  if(!file){alert('Selecciona un archivo CSV');return;}
  const reader=new FileReader();
  reader.onload=function(e){
    Papa.parse(e.target.result,{header:true,skipEmptyLines:true,complete:function(result){
      const lista=result.data.map(p=>({
        codigo_oem:  (p.codigo_oem  || '').trim(),
        nombre:      (p.nombre      || '').trim(),
        marca:       (p.marca       || '').trim(),
        modelo:      (p.modelo      || '').trim(),
        anio:        (p.anio        || '').trim(),
        precio:      parseFloat(p.precio)||0,
        stock:       parseInt(p.stock)||0,
        imagen_url:  (p.imagen_url  || '').trim(),
        descripcion: (p.descripcion || '').trim()
      })).filter(p=>p.codigo_oem);
      localStorage.setItem('productos300',JSON.stringify(lista));
      document.getElementById('resCSV').textContent=`‚úÖ ${lista.length} productos cargados`;
      renderInventario();
    }});
  };
  reader.readAsText(file);
}

function agregarProducto(){
  const cod=document.getElementById('quickCodigo').value;
  const nom=document.getElementById('quickNombre').value;
  const mar=document.getElementById('quickMarca').value;
  const mod=document.getElementById('quickModelo').value;
  const anio=document.getElementById('quickAnio').value;
  const pre=parseFloat(document.getElementById('quickPrecio').value)||0;
  const stock=parseInt(document.getElementById('quickStock').value)||0;
  const img=document.getElementById('quickImg').value;
  const desc=document.getElementById('quickDesc').value;
  if(!cod||!nom){alert('C√≥digo y nombre obligatorios');return;}
  const lista=JSON.parse(localStorage.getItem('productos300'))||[];
  const existe=lista.find(p=>p.codigo_oem===cod);
  if(existe){
    Object.assign(existe,{nombre:nom,marca:mar,modelo:mod,anio:anio,precio:pre,stock:stock,imagen_url:img,descripcion:desc});
  }else{
    lista.push({codigo_oem:cod,nombre:nom,marca:mar,modelo:mod,anio:anio,precio:pre,stock:stock,imagen_url:img,descripcion:desc});
  }
  localStorage.setItem('productos300',JSON.stringify(lista));
  alert('Producto guardado');
  renderInventario();
}

function renderInventario(){
  const lista=JSON.parse(localStorage.getItem('productos300'))||[];
  const div=document.getElementById('listaProductos');
  div.innerHTML='';
  const totalPag=Math.ceil(lista.length/POR_PAG);
  pagina=Math.min(Math.max(pagina,1),totalPag);
  const ini=(pagina-1)*POR_PAG;
  const fin=ini+POR_PAG;
  const ver=lista.slice(ini,fin);
  div.innerHTML='<table class="inventario"><thead><tr><th>C√≥digo</th><th>Nombre</th><th>Marca</th><th>Modelo</th><th>A√±o</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr></thead><tbody>';
  ver.forEach(p=>{
    div.innerHTML+=`<tr>
      <td>${p.codigo_oem}</td><td>${p.nombre}</td><td>${p.marca}</td><td>${p.modelo}</td><td>${p.anio}</td>
      <td><input type="number" value="${p.precio}" onchange="actualizarCampo('${p.codigo_oem}','precio',this.value)"></td>
      <td><input type="number" value="${p.stock}" onchange="actualizarCampo('${p.codigo_oem}','stock',this.value)"></td>
      <td><button onclick="eliminarProducto('${p.codigo_oem}')">üóëÔ∏è</button></td>
    </tr>`;
  });
  div.innerHTML+='</tbody></table>';
  document.querySelector('#inventario button[onclick*="cambiarPagina(-1)"]').disabled=pagina===1;
  document.querySelector('#inventario button[onclick*="cambiarPagina(1)"]').disabled=pagina===totalPag;
}

function actualizarCampo(codigo,campo,valor){
  const lista=JSON.parse(localStorage.getItem('productos300'))||[];
  const p=lista.find(x=>x.codigo_oem===codigo);
  if(p){p[campo]=campo==='precio'?parseFloat(valor):parseInt(valor);localStorage.setItem('productos300',JSON.stringify(lista));}
}

function eliminarProducto(codigo){
  let lista=JSON.parse(localStorage.getItem('productos300'))||[];
  lista=lista.filter(p=>p.codigo_oem!==codigo);
  localStorage.setItem('productos300',JSON.stringify(lista));
  renderInventario();
}

function cambiarPagina(dir){
  pagina+=dir;
  renderInventario();
}

/* ---------- ARRANQUE ---------- */
function iniciarTodo(){
  if(!localStorage.getItem('productos300')){
    localStorage.setItem('productos300',JSON.stringify([
      {codigo_oem:'VOL-CIV-18',nombre:'Airbag Volante',marca:'Honda',modelo:'Civic',anio:'2018',precio:3500,stock:5,imagen_url:'',descripcion:'Original Honda'},
      {codigo_oem:'AIR-COP-20',nombre:'Airbag Copiloto',marca:'Toyota',modelo:'RAV4',anio:'2020',precio:2800,stock:3,imagen_url:'',descripcion:'Original Toyota'},
      {codigo_oem:'MOD-SRS-19',nombre:'M√≥dulo SRS',marca:'Nissan',modelo:'Sentra',anio:'2019',precio:3200,stock:7,imagen_url:'',descripcion:'M√≥dulo restaurado'},
      {codigo_oem:'SEN-IMP-21',nombre:'Sensor Impacto',marca:'Mazda',modelo:'3',anio:'2021',precio:1500,stock:10,imagen_url:'',descripcion:'Sensor nuevo'}
    ]));
  }
  productos=JSON.parse(localStorage.getItem('productos300'));
  renderInventario();
  renderOrdenes();
  renderTienda();
  mostrarDescripcion();
}
</script>
</body>
</html>
